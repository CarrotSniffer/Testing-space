(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const n of l)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function o(l){const n={};return l.integrity&&(n.integrity=l.integrity),l.referrerPolicy&&(n.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?n.credentials="include":l.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(l){if(l.ep)return;l.ep=!0;const n=o(l);fetch(l.href,n)}})();const u=14,S=64,k=32,p=S/2,a=k/2,ce=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#e84393","#00b894","#fdcb6e"];function Ye(){return ce[Math.floor(Math.random()*ce.length)]}const v={empty:{type:"empty",label:"Clear",icon:"X",cost:0,description:"Demolish",popEffect:0,incomeEffect:0,happinessEffect:0,height:0,wallLeft:"",wallRight:"",roofColor:"",category:"special",upgradeCostMult:0},residential:{type:"residential",label:"House",icon:"H",cost:100,description:"+10 pop, +$5/s",popEffect:10,incomeEffect:5,happinessEffect:-1,height:18,wallLeft:"#d4c4a0",wallRight:"#baa880",roofColor:"#b04030",category:"zone",upgradeCostMult:1.5},commercial:{type:"commercial",label:"Shop",icon:"S",cost:200,description:"+$15/s, +2 happy",popEffect:0,incomeEffect:15,happinessEffect:2,height:26,wallLeft:"#e8dcc8",wallRight:"#ccc0a8",roofColor:"#3080c0",category:"zone",upgradeCostMult:1.5},industrial:{type:"industrial",label:"Factory",icon:"F",cost:300,description:"+$25/s, -5 happy",popEffect:0,incomeEffect:25,happinessEffect:-5,height:20,wallLeft:"#a0a0a0",wallRight:"#888888",roofColor:"#606060",category:"zone",upgradeCostMult:1.5},park:{type:"park",label:"Park",icon:"P",cost:50,description:"+8 happy, -$2/s",popEffect:0,incomeEffect:-2,happinessEffect:8,height:2,wallLeft:"#3a8032",wallRight:"#2e6828",roofColor:"#4aa040",category:"infrastructure",upgradeCostMult:1.2},road:{type:"road",label:"Road",icon:"R",cost:25,description:"Connect areas",popEffect:0,incomeEffect:0,happinessEffect:0,height:1,wallLeft:"#555",wallRight:"#444",roofColor:"#666",category:"infrastructure",upgradeCostMult:0},power:{type:"power",label:"Power",icon:"Z",cost:500,description:"Powers 20 bldgs",popEffect:0,incomeEffect:-10,happinessEffect:-2,height:30,wallLeft:"#c0b070",wallRight:"#a09060",roofColor:"#d0c050",category:"infrastructure",upgradeCostMult:2},hospital:{type:"hospital",label:"Hospital",icon:"+",cost:400,description:"+15% pop cap, +5 happy",popEffect:15,incomeEffect:-8,happinessEffect:5,height:24,wallLeft:"#e8e8e8",wallRight:"#d0d0d0",roofColor:"#f0f0f0",category:"service",upgradeCostMult:1.8},school:{type:"school",label:"School",icon:"B",cost:350,description:"+10% income, +3 happy",popEffect:0,incomeEffect:-5,happinessEffect:3,height:22,wallLeft:"#c8a878",wallRight:"#b09060",roofColor:"#904030",category:"service",upgradeCostMult:1.6},fire_station:{type:"fire_station",label:"Fire Stn",icon:"!",cost:250,description:"Prevents fires, +3 happy",popEffect:0,incomeEffect:-3,happinessEffect:3,height:20,wallLeft:"#d04040",wallRight:"#b03030",roofColor:"#cc3333",category:"service",upgradeCostMult:1.4},police:{type:"police",label:"Police",icon:"P",cost:300,description:"+4 happy, reduces crime",popEffect:0,incomeEffect:-4,happinessEffect:4,height:22,wallLeft:"#4060a0",wallRight:"#305080",roofColor:"#3050a0",category:"service",upgradeCostMult:1.5}},Xe=["residential","commercial","industrial","park","road","power","hospital","school","fire_station","police","empty"],He={zone:"Zones",service:"Services",infrastructure:"Infra",special:"Other"};function ie(e,t){const o=v[e];return o.upgradeCostMult===0||t>=3?1/0:Math.round(o.cost*o.upgradeCostMult*t)}function q(e){return 1+(e-1)*.5}function Ne(){return[{id:"first_house",label:"First Home",icon:"‚åÇ",description:"Build your first house",check:e=>L(e.grid,"residential")>=1,unlocked:!1},{id:"growing_town",label:"Growing Town",icon:"‚ò∫",description:"Reach 50 population",check:e=>e.population>=50,unlocked:!1},{id:"thriving_city",label:"Thriving City",icon:"‚òÖ",description:"Reach 150 population",check:e=>e.population>=150,unlocked:!1},{id:"wealthy",label:"Wealthy",icon:"$",description:"Accumulate $10,000",check:e=>e.money>=1e4,unlocked:!1},{id:"tycoon",label:"Tycoon",icon:"‚ô†",description:"Earn $50,000 total",check:e=>e.totalMoneyEarned>=5e4,unlocked:!1},{id:"happy_citizens",label:"Happy Citizens",icon:"‚ù§",description:"Reach 90% happiness",check:e=>e.happiness>=90,unlocked:!1},{id:"industrial_rev",label:"Industrial Revolution",icon:"‚öô",description:"Build 5 factories",check:e=>L(e.grid,"industrial")>=5,unlocked:!1},{id:"green_city",label:"Green City",icon:"‚ô£",description:"Build 5 parks",check:e=>L(e.grid,"park")>=5,unlocked:!1},{id:"diversified",label:"Diversified",icon:"‚ú¶",description:"Build one of every type",check:e=>["residential","commercial","industrial","park","power","hospital","school","fire_station","police"].every(o=>L(e.grid,o)>=1),unlocked:!1},{id:"full_grid",label:"Metropolis",icon:"‚ñà",description:"Fill every tile",check:e=>L(e.grid,"empty")===0,unlocked:!1},{id:"upgrader",label:"Upgrader",icon:"‚Üë",description:"Upgrade any building to level 3",check:e=>{for(const t of e.grid)for(const o of t)if(o.level>=3)return!0;return!1},unlocked:!1},{id:"safe_city",label:"Safe City",icon:"!",description:"Build a fire station and police station",check:e=>L(e.grid,"fire_station")>=1&&L(e.grid,"police")>=1,unlocked:!1}]}function L(e,t){let o=0;for(const i of e)for(const l of i)l.type===t&&o++;return o}function Oe(e,t,o){switch(o%4){case 1:return[t,u-1-e];case 2:return[u-1-e,u-1-t];case 3:return[u-1-t,e];default:return[e,t]}}function we(e,t,o){switch(o%4){case 1:return[u-1-t,e];case 2:return[u-1-e,u-1-t];case 3:return[t,u-1-e];default:return[e,t]}}function le(e,t,o=0){const[i,l]=Oe(e,t,o);return[(l-i)*p,(l+i)*a]}function Fe(e,t,o=0){const i=(e/p+t/a)/2,l=(t/a-e/p)/2,n=Math.floor(l),s=Math.floor(i);return we(n,s,o)}function w(e,t,o,i,l){e.beginPath(),e.moveTo(t,o-l/2),e.lineTo(t+i/2,o),e.lineTo(t,o+l/2),e.lineTo(t-i/2,o),e.closePath()}function m(e,t,o,i){e.beginPath(),e.moveTo(t-p,o),e.lineTo(t,o+a),e.lineTo(t,o+a+i),e.lineTo(t-p,o+i),e.closePath()}function g(e,t,o,i){e.beginPath(),e.moveTo(t+p,o),e.lineTo(t,o+a),e.lineTo(t,o+a+i),e.lineTo(t+p,o+i),e.closePath()}const ze=["#4a8a3a","#4e9040","#468636","#509444"];function je(e,t,o,i,l){const n=(i*7+l*13)%4;w(e,t,o+a,S,k),e.fillStyle=ze[n],e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.5,e.stroke()}function Ue(e,t,o,i){if(i<=1)return;const l=i-1,n=t-l*4;for(let s=0;s<l;s++){const r=n+s*8;e.fillStyle="#ffd700",e.strokeStyle="#b8960f",e.lineWidth=.5,Ge(e,r,o,3,5)}}function Ge(e,t,o,i,l){e.beginPath();for(let n=0;n<5;n++){const s=n*4*Math.PI/5-Math.PI/2,r=l;e.lineTo(t+Math.cos(s)*r,o+Math.sin(s)*r);const f=s+2*Math.PI/10;e.lineTo(t+Math.cos(f)*i,o+Math.sin(f)*i)}e.closePath(),e.fill(),e.stroke()}function qe(e,t,o,i){const l=i*.15;for(let n=0;n<6;n++){const s=t+Math.sin(l+n*1.3)*8-4,r=o+Math.cos(l+n*.9)*3-6-n*2,f=4+Math.sin(l+n)*2,h=.6+Math.sin(l*2+n)*.3;e.fillStyle=n<3?`rgba(255,100,20,${h})`:`rgba(255,200,50,${h})`,e.beginPath(),e.ellipse(s,r,f,f*1.3,0,0,Math.PI*2),e.fill()}}function Ze(e,t,o){m(e,t,o,18),e.fillStyle="#e8dbc4",e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.5,e.stroke(),e.save(),m(e,t,o,18),e.clip();for(let s=0;s<2;s++){const r=t-p+6+s*13,f=o+4;e.fillStyle="#5a7a5a",e.fillRect(r-2,f-1,2,7),e.fillRect(r+7,f-1,2,7),e.fillStyle="#b8ddf8",e.fillRect(r,f,7,5),e.strokeStyle="#f0e8d0",e.lineWidth=.8,e.strokeRect(r,f,7,5),e.beginPath(),e.moveTo(r+3.5,f),e.lineTo(r+3.5,f+5),e.moveTo(r,f+2.5),e.lineTo(r+7,f+2.5),e.strokeStyle="#f0e8d0",e.lineWidth=.6,e.stroke()}e.restore(),g(e,t,o,18),e.fillStyle="#d4c8a8",e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.5,e.stroke(),e.save(),g(e,t,o,18),e.clip(),e.fillStyle="#a09080",e.fillRect(t+3,o+a+18-3,10,3),e.fillStyle="#8b5e3c",e.fillRect(t+5,o+a+18-12,7,9),e.strokeStyle="#6a4428",e.lineWidth=.8,e.strokeRect(t+5,o+a+18-12,7,9),e.strokeStyle="#7a5030",e.strokeRect(t+6,o+a+18-11,2.5,3.5),e.strokeRect(t+9,o+a+18-11,2.5,3.5),e.fillStyle="#d4aa40",e.beginPath(),e.arc(t+10.5,o+a+18-7,.8,0,Math.PI*2),e.fill();const n=o+a+4;e.fillStyle="#5a7a5a",e.fillRect(t+15,n-1,2,7),e.fillRect(t+24,n-1,2,7),e.fillStyle="#b8ddf8",e.fillRect(t+17,n,7,5),e.strokeStyle="#f0e8d0",e.lineWidth=.6,e.strokeRect(t+17,n,7,5),e.restore(),e.beginPath(),e.moveTo(t,o-12),e.lineTo(t-p-2,o+1),e.lineTo(t,o+a+1),e.closePath(),e.fillStyle="#b84835",e.fill(),e.save(),e.beginPath(),e.moveTo(t,o-12),e.lineTo(t-p-2,o+1),e.lineTo(t,o+a+1),e.closePath(),e.clip(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.5;for(let s=1;s<5;s++){const r=s/5,f=o-12+(o+a+1-(o-12))*r;e.beginPath(),e.moveTo(t-p-4,f+2),e.lineTo(t+4,f),e.stroke()}e.restore(),e.beginPath(),e.moveTo(t,o-12),e.lineTo(t+p+2,o+1),e.lineTo(t,o+a+1),e.closePath(),e.fillStyle="#9a3828",e.fill(),e.beginPath(),e.moveTo(t,o-12),e.lineTo(t,o+a+1),e.strokeStyle="#c85040",e.lineWidth=1.2,e.stroke(),e.fillStyle="#9a7060",e.fillRect(t+p*.3,o-12-2,5,10),e.fillStyle="#8a6050",e.fillRect(t+p*.3-.5,o-12-3,6,2)}function Ke(e,t,o){m(e,t,o,26),e.fillStyle="#e8dcc8",e.fill(),e.save(),m(e,t,o,26),e.clip(),e.strokeStyle="rgba(0,0,0,0.06)",e.lineWidth=1;for(let l=1;l<3;l++){const n=o+l*8;e.beginPath(),e.moveTo(t-p-5,n),e.lineTo(t+5,n+a),e.stroke()}e.fillStyle="#a0d8f0";for(let l=0;l<2;l++)for(let n=0;n<2;n++)e.fillRect(t-p+5+n*12,o+3+l*10,8,6),e.strokeStyle="#c0b8a0",e.lineWidth=.5,e.strokeRect(t-p+5+n*12,o+3+l*10,8,6);e.restore(),g(e,t,o,26),e.fillStyle="#ccc0a8",e.fill(),e.save(),g(e,t,o,26),e.clip(),e.fillStyle="#90d0e8",e.fillRect(t+3,o+a+26-14,20,10),e.strokeStyle="#808080",e.lineWidth=.8,e.strokeRect(t+3,o+a+26-14,20,10),e.fillStyle="#e0a080",e.fillRect(t+8,o+a+26-12,3,6),e.fillRect(t+14,o+a+26-11,3,5),e.fillStyle="#a0d8f0",e.fillRect(t+5,o+a+3,6,5),e.fillRect(t+15,o+a+3,6,5),e.restore(),w(e,t,o,S,k),e.fillStyle="#3080c0",e.fill(),w(e,t,o,S-4,k-2),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1,e.stroke(),e.beginPath(),e.moveTo(t,o+a),e.lineTo(t+p+4,o+2),e.lineTo(t+p+4,o+5),e.lineTo(t,o+a+3),e.closePath(),e.fillStyle="#d04040",e.fill(),e.save(),e.beginPath(),e.moveTo(t,o+a),e.lineTo(t+p+4,o+2),e.lineTo(t+p+4,o+5),e.lineTo(t,o+a+3),e.closePath(),e.clip(),e.fillStyle="#f0f0f0";for(let l=0;l<5;l++)e.fillRect(t+l*8,o-2,4,a+10);e.restore(),e.fillStyle="#f0e8c0",e.fillRect(t+p*.2,o+1,p*.6,4),e.fillStyle="#d04040",e.font="4px sans-serif",e.textAlign="center",e.fillText("SHOP",t+p*.5,o+4)}function Ve(e,t,o){m(e,t,o,20),e.fillStyle="#a0a0a0",e.fill(),e.save(),m(e,t,o,20),e.clip(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=1;for(let f=0;f<3;f++)e.beginPath(),e.moveTo(t-p+8+f*8,o-2),e.lineTo(t-p+8+f*8,o+20+a+2),e.stroke();e.fillStyle="#606060",e.fillRect(t-p+3,o+20-6,12,8),e.fillStyle="#505050";for(let f=0;f<3;f++)e.fillRect(t-p+3,o+20-6+f*3,12,1);e.restore(),g(e,t,o,20),e.fillStyle="#888",e.fill(),e.save(),g(e,t,o,20),e.clip(),e.fillStyle="#606060",e.fillRect(t+4,o+a+20-12,16,12),e.fillStyle="#e0c030",e.fillRect(t+4,o+a+20-12,16,2),e.restore(),w(e,t,o,S,k),e.fillStyle="#606060",e.fill();const l=t-8,n=o-12;e.fillStyle="#787878",e.fillRect(l-3,n,6,14),e.fillStyle="#686868",e.fillRect(l-4,n-1,8,3),e.fillStyle="#c04030",e.fillRect(l-3,n+2,6,2);const s=t+6,r=o-8;e.fillStyle="#787878",e.fillRect(s-3,r,6,10),e.fillStyle="#686868",e.fillRect(s-4,r-1,8,3),e.fillStyle="#c04030",e.fillRect(s-3,r+2,6,2)}function x(e,t,o,i){e.fillStyle="#6a4a2a",e.fillRect(t-1.5,o-i*.4,3,i*.5);const l=["#2a7a28","#38942e","#48a838"];for(let n=0;n<3;n++){const s=i*(1-n*.25),r=o-i*.4-n*(i*.28);e.beginPath(),e.ellipse(t,r,s*.55,s*.4,0,0,Math.PI*2),e.fillStyle=l[n],e.fill()}e.beginPath(),e.ellipse(t-i*.15,o-i*.9,i*.12,i*.1,-.3,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.15)",e.fill()}function Je(e,t,o,i){w(e,t,o+a,S,k),e.fillStyle="#4aa040",e.fill(),e.beginPath(),e.moveTo(t-2,o+a-a/2),e.quadraticCurveTo(t,o+a,t+3,o+a+a/2),e.strokeStyle="#c8b888",e.lineWidth=3,e.stroke();const l=i%4;x(e,t-10-l*2,o+a-8,12),x(e,t+10+l*1,o+a+2,10),l>1&&x(e,t-2,o+a-14,8),e.fillStyle="#8a6a3a",e.fillRect(t+5,o+a+5,8,2),e.fillRect(t+5,o+a+5,1.5,4),e.fillRect(t+11.5,o+a+5,1.5,4);const n=["#f04060","#f0d040","#e070d0","#ffffff"];for(let s=0;s<4;s++){const r=t-16+s*5+(i*3+s*7)%5,f=o+a+4+(i*5+s*11)%6;e.fillStyle=n[(i+s)%n.length],e.fillRect(r,f,2,2),e.fillStyle="#40a030",e.fillRect(r+.5,f+2,1,2)}}function Qe(e,t,o){w(e,t,o+a,S,k),e.fillStyle="#555",e.fill(),e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth=.5,e.stroke(),e.beginPath(),e.setLineDash([3,3]),e.moveTo(t-p*.4,o+a-a*.4+1),e.lineTo(t+p*.4,o+a+a*.4+1),e.strokeStyle="#cc9920",e.lineWidth=1,e.stroke(),e.setLineDash([])}function xe(e,t,o){m(e,t,o,30),e.fillStyle="#c0b070",e.fill(),e.save(),m(e,t,o,30),e.clip();for(let s=0;s<6;s++)e.fillStyle=s%2===0?"#e0c030":"#303030",e.fillRect(t-p,o+30-4+s*3-14,p+5,3);e.restore(),g(e,t,o,30),e.fillStyle="#a09060",e.fill(),e.save(),g(e,t,o,30),e.clip(),e.fillStyle="#808060",e.fillRect(t+6,o+a+4,14,18),e.fillStyle="#40ff40",e.fillRect(t+9,o+a+7,3,3),e.fillStyle="#ff4040",e.fillRect(t+14,o+a+7,3,3),e.fillStyle="#40ff40",e.fillRect(t+9,o+a+13,3,3),e.fillStyle="#ffcc00",e.fillRect(t+14,o+a+13,3,3),e.restore(),w(e,t,o,S,k),e.fillStyle="#d0c050",e.fill();const l=t-5,n=o-16;e.fillStyle="#b0a888",e.beginPath(),e.moveTo(l-7,n+20),e.quadraticCurveTo(l-8,n+10,l-5,n),e.lineTo(l+5,n),e.quadraticCurveTo(l+8,n+10,l+7,n+20),e.closePath(),e.fill(),e.fillStyle="#908870",e.beginPath(),e.moveTo(l+1,n),e.quadraticCurveTo(l+8,n+10,l+7,n+20),e.lineTo(l+0,n+20),e.quadraticCurveTo(l+1,n+10,l+1,n),e.closePath(),e.fill(),e.beginPath(),e.ellipse(l,n,6,2.5,0,0,Math.PI*2),e.fillStyle="#a09878",e.fill(),e.fillStyle="#f0d000",e.beginPath(),e.moveTo(t+6,o-2),e.lineTo(t+2,o+3),e.lineTo(t+5,o+3),e.lineTo(t+1,o+8),e.lineTo(t+8,o+2),e.lineTo(t+5,o+2),e.closePath(),e.fill()}function et(e,t,o){m(e,t,o,24),e.fillStyle="#f0f0f0",e.fill(),e.strokeStyle="rgba(0,0,0,0.08)",e.lineWidth=.5,e.stroke(),e.save(),m(e,t,o,24),e.clip();for(let l=0;l<3;l++)for(let n=0;n<2;n++)e.fillStyle="#a0e0f0",e.fillRect(t-p+4+n*12,o+2+l*7,7,5),e.strokeStyle="#d0d0d0",e.lineWidth=.5,e.strokeRect(t-p+4+n*12,o+2+l*7,7,5);e.restore(),g(e,t,o,24),e.fillStyle="#e0e0e0",e.fill(),e.strokeStyle="rgba(0,0,0,0.08)",e.lineWidth=.5,e.stroke(),e.save(),g(e,t,o,24),e.clip(),e.fillStyle="#80c0e0",e.fillRect(t+6,o+a+24-12,14,12),e.strokeStyle="#6090b0",e.lineWidth=.8,e.strokeRect(t+6,o+a+24-12,14,12),e.fillStyle="#e04040",e.fillRect(t+11,o+a+24-10,4,8),e.fillRect(t+9,o+a+24-8,8,4),e.restore(),w(e,t,o,S,k),e.fillStyle="#e8e8e8",e.fill(),w(e,t,o,S-6,k-3),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.5,e.stroke(),e.fillStyle="#e04040",e.fillRect(t-1.5,o-4,3,8),e.fillRect(t-4,o-1.5,8,3),e.beginPath(),e.arc(t,o,6,0,Math.PI*2),e.strokeStyle="#d0d0d0",e.lineWidth=.8,e.stroke()}function tt(e,t,o){m(e,t,o,22),e.fillStyle="#c8a070",e.fill(),e.save(),m(e,t,o,22),e.clip(),e.strokeStyle="rgba(0,0,0,0.08)",e.lineWidth=.5;for(let n=0;n<6;n++){const s=o+n*4;e.beginPath(),e.moveTo(t-p-2,s),e.lineTo(t+2,s+a*.5),e.stroke()}for(let n=0;n<3;n++)e.fillStyle="#a0d8f0",e.fillRect(t-p+3+n*9,o+4,6,8),e.strokeStyle="#b09060",e.lineWidth=.5,e.strokeRect(t-p+3+n*9,o+4,6,8);e.restore(),g(e,t,o,22),e.fillStyle="#b09060",e.fill(),e.save(),g(e,t,o,22),e.clip(),e.fillStyle="#6a4428",e.fillRect(t+8,o+a+22-14,10,14),e.strokeStyle="#503018",e.lineWidth=.8,e.strokeRect(t+8,o+a+22-14,10,14),e.fillStyle="#a0d8f0",e.fillRect(t+10,o+a+22-12,6,4),e.fillStyle="#f0e8c0",e.fillRect(t+4,o+a+2,18,5),e.fillStyle="#904030",e.font="3.5px sans-serif",e.textAlign="center",e.fillText("SCHOOL",t+13,o+a+5.5),e.restore();const l=10;e.beginPath(),e.moveTo(t,o-l),e.lineTo(t-p-2,o+1),e.lineTo(t,o+a+1),e.closePath(),e.fillStyle="#904030",e.fill(),e.beginPath(),e.moveTo(t,o-l),e.lineTo(t+p+2,o+1),e.lineTo(t,o+a+1),e.closePath(),e.fillStyle="#7a3020",e.fill(),e.beginPath(),e.moveTo(t,o-l),e.lineTo(t,o+a+1),e.strokeStyle="#a04030",e.lineWidth=1,e.stroke(),e.fillStyle="#c8a070",e.fillRect(t-3,o-l-8,6,8),e.fillStyle="#b09060",e.fillRect(t-4,o-l-9,8,2),e.fillStyle="#d4aa40",e.beginPath(),e.arc(t,o-l-4,2,0,Math.PI*2),e.fill()}function ot(e,t,o){m(e,t,o,20),e.fillStyle="#c83030",e.fill(),e.save(),m(e,t,o,20),e.clip();for(let l=0;l<2;l++)e.fillStyle="#a0d8f0",e.fillRect(t-p+4+l*12,o+3,8,5),e.strokeStyle="#a02020",e.lineWidth=.5,e.strokeRect(t-p+4+l*12,o+3,8,5);e.fillStyle="#ff6060",e.fillRect(t-p,o+20-2,p+4,3),e.restore(),g(e,t,o,20),e.fillStyle="#b02828",e.fill(),e.save(),g(e,t,o,20),e.clip(),e.fillStyle="#e0d0b0",e.fillRect(t+3,o+a+20-16,20,16),e.strokeStyle="#b0a080",e.lineWidth=.5;for(let l=0;l<4;l++)e.beginPath(),e.moveTo(t+3,o+a+20-16+l*4),e.lineTo(t+23,o+a+20-16+l*4),e.stroke();e.restore(),w(e,t,o,S,k),e.fillStyle="#cc3333",e.fill(),e.fillStyle="#ff4040",e.beginPath(),e.arc(t,o-2,3,0,Math.PI*2),e.fill(),e.fillStyle="#ffaa00",e.beginPath(),e.arc(t,o-2,1.5,0,Math.PI*2),e.fill(),e.fillStyle="#d04040",e.fillRect(t-p*.3-2,o-14,4,14),e.fillStyle="#ff8080",e.fillRect(t-p*.3-3,o-15,6,2)}function lt(e,t,o){m(e,t,o,22),e.fillStyle="#4060a0",e.fill(),e.save(),m(e,t,o,22),e.clip();for(let l=0;l<2;l++)e.fillStyle="#a0d8f0",e.fillRect(t-p+4+l*12,o+3,8,6),e.strokeStyle="#305080",e.lineWidth=.5,e.strokeRect(t-p+4+l*12,o+3,8,6);e.fillStyle="#d4aa40",e.beginPath(),e.arc(t-p+14,o+15,3,0,Math.PI*2),e.fill(),e.restore(),g(e,t,o,22),e.fillStyle="#305080",e.fill(),e.save(),g(e,t,o,22),e.clip(),e.fillStyle="#203860",e.fillRect(t+8,o+a+22-14,10,14),e.strokeStyle="#102040",e.lineWidth=.8,e.strokeRect(t+8,o+a+22-14,10,14),e.fillStyle="#f0e8c0",e.fillRect(t+3,o+a+2,20,5),e.fillStyle="#305080",e.font="3px sans-serif",e.textAlign="center",e.fillText("POLICE",t+13,o+a+5.5),e.restore(),w(e,t,o,S,k),e.fillStyle="#3050a0",e.fill(),e.fillStyle="#4080ff",e.beginPath(),e.arc(t-4,o-2,2.5,0,Math.PI*2),e.fill(),e.fillStyle="#ff4040",e.beginPath(),e.arc(t+4,o-2,2.5,0,Math.PI*2),e.fill(),e.fillStyle="#c0c0c0",e.fillRect(t+p*.3,o-16,1.5,16),e.fillStyle="#3050a0",e.fillRect(t+p*.3+1.5,o-16,8,5)}function nt(e,t){const o=t.x,i=t.y;e.fillStyle="rgba(0,0,0,0.15)",e.beginPath(),e.ellipse(o,i+1,2.5,1,0,0,Math.PI*2),e.fill(),e.fillStyle=t.color,e.fillRect(o-1.5,i-5,3,4),e.fillStyle="#f0d0a0",e.beginPath(),e.arc(o,i-6.5,2,0,Math.PI*2),e.fill();const l=Math.sin(t.x*.5+t.y*.3)>0;e.fillStyle="#404060",e.fillRect(o-1.5,i-1,1.2,l?2:1.5),e.fillRect(o+.3,i-1,1.2,l?1.5:2)}function it(e,t){const o=Math.max(0,.4*(1-t.age/t.maxAge));e.fillStyle=`rgba(180,180,180,${o})`,e.beginPath(),e.arc(t.x,t.y,t.size*(.5+t.age/t.maxAge*.8),0,Math.PI*2),e.fill()}function st(e){if(e<.2)return{r:10,g:15,b:50,a:.35};if(e<.3){const t=(e-.2)/.1;return{r:Math.round(10+t*30),g:Math.round(15+t*20),b:Math.round(50-t*40),a:.35-t*.3}}else{if(e<.7)return{r:0,g:0,b:0,a:0};if(e<.8){const t=(e-.7)/.1;return{r:Math.round(40*t),g:Math.round(15*t),b:Math.round(10*t),a:t*.2}}else{const t=(e-.8)/.2;return{r:Math.round(40-t*30),g:Math.round(15-t*0),b:Math.round(10+t*40),a:.2+t*.15}}}}function at(e){return e<.2?"Night":e<.3?"Dawn":e<.7?"Day":e<.8?"Dusk":"Night"}let me=0;function rt(e,t,o,i,l,n,s,r,f){me++;const h=window.devicePixelRatio||1,c=t.width/h,y=t.height/h;e.save(),e.scale(h,h);const M=e.createLinearGradient(0,0,0,y);M.addColorStop(0,"#1a2a1a"),M.addColorStop(.5,"#1e321e"),M.addColorStop(1,"#142414"),e.fillStyle=M,e.fillRect(0,0,c,y);const D=c/2+i,V=y*.38+l;e.translate(D,V),e.scale(n,n);for(let T=0;T<u*2-1;T++)for(let C=Math.max(0,T-u+1);C<=Math.min(T,u-1);C++){const B=T-C;if(B<0||B>=u)continue;const[O,F]=we(C,B,s),J=(B-C)*p,Q=(B+C)*a,Y=o.grid[O][F];if(je(e,J,Q,O,F),O===r&&F===f&&(w(e,J,Q+a,S,k),e.fillStyle="rgba(233,69,96,0.25)",e.fill()),Y.type!=="empty"){switch(e.save(),e.translate(J,Q),Y.type){case"residential":Ze(e,0,0);break;case"commercial":Ke(e,0,0);break;case"industrial":Ve(e,0,0);break;case"park":Je(e,0,0,O*u+F);break;case"road":Qe(e,0,0);break;case"power":xe(e,0,0);break;case"hospital":et(e,0,0);break;case"school":tt(e,0,0);break;case"fire_station":ot(e,0,0);break;case"police":lt(e,0,0);break}const I=v[Y.type].height;Ue(e,0,-I-6,Y.level),Y.onFire&&qe(e,0,0,me),e.restore()}for(const I of o.citizens){const Ae=Math.floor((I.y/a+I.x/p)/2+.5),De=Math.floor((I.y/a-I.x/p)/2+.5);Ae===C&&De===B&&nt(e,I)}}for(const T of o.smoke)it(e,T);e.restore();const b=st(o.dayTime);b.a>.01&&(e.fillStyle=`rgba(${b.r},${b.g},${b.b},${b.a})`,e.fillRect(0,0,t.width,t.height))}function Me(){const e=[];for(let t=0;t<u;t++){const o=[];for(let i=0;i<u;i++)o.push({type:"empty",level:1});e.push(o)}return{grid:e,money:1e3,population:0,happiness:50,tick:0,citizens:[],smoke:[],speed:1,events:[],dayTime:.35,totalBuildings:0,totalMoneyEarned:0,notifications:[],achievementsUnlocked:[]}}function H(e){const t={empty:0,residential:0,commercial:0,industrial:0,park:0,road:0,power:0,hospital:0,school:0,fire_station:0,police:0};for(const o of e)for(const i of o)t[i.type]++;return t}function se(e){let t=0;for(const o of e)for(const i of o)i.type!=="empty"&&t++;return t}function ft(e,t,o){const i=[],l=[[-1,0],[1,0],[0,-1],[0,1]];for(const[n,s]of l){const r=t+n,f=o+s;r>=0&&r<u&&f>=0&&f<u&&i.push(e[r][f].type)}return i}function ae(e,t,o){const i=e[t][o],l=ft(e,t,o);let n=0,s=0;switch(i.type){case"residential":l.includes("park")&&(s+=3),l.includes("industrial")&&(s-=2),l.includes("hospital")&&(s+=2),l.includes("police")&&(s+=1);break;case"commercial":l.includes("road")&&(n+=3),l.includes("residential")&&(n+=2);break;case"industrial":l.includes("road")&&(n+=4),l.includes("residential")&&(s-=1);break;case"park":l.includes("residential")&&(s+=2);break}return{income:n,happiness:s}}function re(e){const t=H(e);let o=0;for(let l=0;l<u;l++)for(let n=0;n<u;n++){const s=e[l][n];if(s.type==="empty")continue;const r=v[s.type],f=q(s.level),h=ae(e,l,n);if(s.type==="commercial"){const c=Math.min(2,1+t.residential*.1);o+=r.incomeEffect*f*c+h.income}else o+=r.incomeEffect*f+h.income}const i=1+t.school*.1;return o*=i,Math.round(o)}function dt(e){const t=H(e);let o=0;for(const f of e)for(const h of f)if(h.type!=="empty"){const c=q(h.level);o+=v[h.type].popEffect*c}const i=t.commercial*3,l=se(e)-t.road,n=t.power*20*(1+(t.power>0,0)),s=l>0?Math.min(1,n/l):1,r=1+t.hospital*.15;return Math.round((o+i)*s*r)}function pt(e){const t=H(e);let o=50;for(let i=0;i<u;i++)for(let l=0;l<u;l++){const n=e[i][l];if(n.type==="empty")continue;const s=v[n.type],r=q(n.level),f=ae(e,i,l);o+=s.happinessEffect*r+f.happiness,n.onFire&&(o-=5)}return t.residential>0&&t.commercial>0&&t.industrial>0&&(o+=10),t.police>0&&(o+=t.police*2),Math.max(0,Math.min(100,Math.round(o)))}function U(e,t){const o=[];for(let i=0;i<u;i++)for(let l=0;l<u;l++)t.includes(e[i][l].type)&&o.push([i,l]);return o}function ne(e,t){const[o,i]=le(e,t);return[o+(Math.random()-.5)*p*1.2,i+a+(Math.random()-.5)*a*.8]}function ht(e){const t=[...e.citizens],o=U(e.grid,["residential"]),i=U(e.grid,["commercial","industrial","park","road","hospital","school","police"]),l=Math.min(o.length*2,40);for(;t.length<l&&o.length>0;){const n=o[Math.floor(Math.random()*o.length)],[s,r]=ne(n[0],n[1]);let f=s,h=r;if(i.length>0){const c=i[Math.floor(Math.random()*i.length)];[f,h]=ne(c[0],c[1])}t.push({x:s,y:r,tx:f,ty:h,color:Ye(),speed:.3+Math.random()*.4})}for(;t.length>l;)t.pop();return t}function ut(e,t){const o=U(e.grid,["commercial","industrial","park","road","residential","hospital","school"]);return e.citizens.map(i=>{const l=i.tx-i.x,n=i.ty-i.y,s=Math.sqrt(l*l+n*n);if(s<2){if(o.length>0){const f=o[Math.floor(Math.random()*o.length)],[h,c]=ne(f[0],f[1]);return{...i,tx:h,ty:c}}return i}const r=i.speed*t*.06;return{...i,x:i.x+l/s*r,y:i.y+n/s*r}})}function ct(e){const t=[...e.smoke],o=U(e.grid,["industrial"]);for(const[i,l]of o)if(Math.random()<.6){const[n,s]=le(i,l),r=Math.random()>.5?-8:6;t.push({x:n+r+(Math.random()-.5)*3,y:s-14+(Math.random()-.5)*2,age:0,maxAge:60+Math.random()*40,vx:(Math.random()-.3)*.3,vy:-.4-Math.random()*.3,size:3+Math.random()*3})}for(let i=0;i<u;i++)for(let l=0;l<u;l++)if(e.grid[i][l].onFire&&Math.random()<.4){const[n,s]=le(i,l);t.push({x:n+(Math.random()-.5)*10,y:s-5+(Math.random()-.5)*5,age:0,maxAge:40+Math.random()*30,vx:(Math.random()-.5)*.5,vy:-.6-Math.random()*.4,size:4+Math.random()*4})}return t}function mt(e,t){return e.map(o=>({...o,x:o.x+o.vx*t*.06,y:o.y+o.vy*t*.06,age:o.age+t*.06})).filter(o=>o.age<o.maxAge)}function gt(e){const t=H(e.grid),o=se(e.grid);if(o<5||e.events.length>=2||Math.random()>.08)return null;const i=Math.random();return i<.2&&t.fire_station===0&&o>3?{type:"fire",label:"Fire!",description:"A building caught fire!",duration:8,effect:{}}:i<.45?{type:"boom",label:"Economic Boom",description:"Trade is thriving! +50% income",duration:15,effect:{incomeMult:1.5}}:i<.65?{type:"storm",label:"Storm",description:"Bad weather! -10 happiness",duration:10,effect:{happinessAdd:-10}}:i<.85?{type:"festival",label:"Festival!",description:"Citizens celebrate! +12 happiness",duration:12,effect:{happinessAdd:12}}:{type:"population_surge",label:"Population Surge",description:"New residents arrive! +20 pop",duration:10,effect:{popAdd:20}}}function vt(e){const t=e.grid.map(i=>i.map(l=>({...l}))),o=[];for(let i=0;i<u;i++)for(let l=0;l<u;l++)t[i][l].type!=="empty"&&t[i][l].type!=="road"&&!t[i][l].onFire&&o.push([i,l]);if(o.length>0){const[i,l]=o[Math.floor(Math.random()*o.length)];t[i][l].onFire=!0,t[i][l].fireTimer=8}return{...e,grid:t}}function yt(e){const t=e.grid.map(o=>o.map(i=>({...i})));for(let o=0;o<u;o++)for(let i=0;i<u;i++)t[o][i].onFire&&(t[o][i].fireTimer=(t[o][i].fireTimer||1)-1,t[o][i].fireTimer<=0&&(t[o][i].onFire=!1,t[o][i].fireTimer=void 0,t[o][i].level>1&&t[o][i].level--));return{...e,grid:t}}function bt(e){return(e+1/120)%1}function St(e){if(e.speed===0)return e;let t={...e};t.dayTime=bt(e.dayTime),t=yt(t);const o=re(t.grid),i=dt(t.grid);let l=pt(t.grid),n=1,s=0,r=0;const f=[];for(const b of t.events){const T={...b,duration:b.duration-1};T.duration>0&&f.push(T),b.effect.incomeMult&&(n*=b.effect.incomeMult),b.effect.happinessAdd&&(s+=b.effect.happinessAdd),b.effect.popAdd&&(r+=b.effect.popAdd)}const h=gt(t),c=[...t.notifications];h&&(f.push(h),c.push({text:h.label+": "+h.description,color:h.type==="fire"||h.type==="storm"?"#f87171":h.type==="boom"?"#4ade80":"#facc15",time:Date.now()}),h.type==="fire"&&(t=vt(t))),l=Math.max(0,Math.min(100,l+s));const y=l>=50?1+(l-50)/200:l/50,M=Math.round(o*y*n),D=ht(t),V=ct(t);for(;c.length>20;)c.shift();return{...t,money:t.money+M,population:i+r,happiness:l,tick:t.tick+1,citizens:D,smoke:V,events:f,totalBuildings:se(t.grid),totalMoneyEarned:t.totalMoneyEarned+Math.max(0,M),notifications:c}}function kt(e,t,o,i){if(i==="empty"){if(e.grid[t][o].type==="empty")return null;const n=e.grid.map(r=>r.map(f=>({...f}))),s=Math.round(v[e.grid[t][o].type].cost*.25);return n[t][o]={type:"empty",level:1},{...e,grid:n,money:e.money+s}}if(e.grid[t][o].type!=="empty"||e.money<v[i].cost)return null;const l=e.grid.map(n=>n.map(s=>({...s})));return l[t][o]={type:i,level:1},{...e,grid:l,money:e.money-v[i].cost}}function wt(e,t,o){const i=e.grid[t][o];if(i.type==="empty"||i.type==="road"||i.level>=3)return null;const l=ie(i.type,i.level);if(e.money<l)return null;const n=e.grid.map(s=>s.map(r=>({...r})));return n[t][o].level=i.level+1,{...e,grid:n,money:e.money-l}}function Mt(e,t,o){const i=e.grid[t][o];if(i.type==="empty")return null;const l=v[i.type],n=q(i.level),s=ae(e.grid,t,o);return{income:Math.round(l.incomeEffect*n),happiness:Math.round(l.happinessEffect*n),population:Math.round(l.popEffect*n),adjacencyIncome:s.income,adjacencyHappiness:s.happiness,level:i.level,upgradeCost:ie(i.type,i.level)}}function Tt(){return{camX:0,camY:0,zoom:1,hoverR:-1,hoverC:-1,rotation:0,_dragging:!1,_lastX:0,_lastY:0,_startX:0,_startY:0,_didDrag:!1,_pinching:!1,_pinchDist:0,_pinchZoomStart:1}}function ge(e,t){const o=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(o*o+i*i)}function Et(e,t,o){function i(n,s){const r=e.getBoundingClientRect(),f=n-r.left,h=s-r.top,c=r.width,y=r.height,M=(f-c/2-t.camX)/t.zoom,D=(h-y*.38-t.camY)/t.zoom;return[M,D]}function l(n,s){const[r,f]=i(n,s),[h,c]=Fe(r,f,t.rotation);return h>=0&&h<u&&c>=0&&c<u?[h,c]:[-1,-1]}e.addEventListener("touchstart",n=>{if(n.preventDefault(),n.touches.length===2)t._pinching=!0,t._dragging=!1,t._pinchDist=ge(n.touches[0],n.touches[1]),t._pinchZoomStart=t.zoom;else if(n.touches.length===1&&!t._pinching){const s=n.touches[0];t._dragging=!0,t._lastX=s.clientX,t._lastY=s.clientY,t._startX=s.clientX,t._startY=s.clientY,t._didDrag=!1}},{passive:!1}),e.addEventListener("touchmove",n=>{if(n.preventDefault(),n.touches.length===2&&t._pinching){const r=ge(n.touches[0],n.touches[1])/t._pinchDist;t.zoom=Math.max(.4,Math.min(3,t._pinchZoomStart*r))}else if(n.touches.length===1&&t._dragging){const s=n.touches[0],r=s.clientX-t._lastX,f=s.clientY-t._lastY;t.camX+=r,t.camY+=f,t._lastX=s.clientX,t._lastY=s.clientY;const h=s.clientX-t._startX,c=s.clientY-t._startY;(Math.abs(h)>8||Math.abs(c)>8)&&(t._didDrag=!0);const[y,M]=l(s.clientX,s.clientY);t.hoverR=y,t.hoverC=M}},{passive:!1}),e.addEventListener("touchend",n=>{if(n.preventDefault(),t._pinching){n.touches.length<2&&(t._pinching=!1);return}if(!t._didDrag&&n.changedTouches.length>0){const s=n.changedTouches[0],[r,f]=l(s.clientX,s.clientY);r>=0&&f>=0&&o(r,f)}t._dragging=!1,t.hoverR=-1,t.hoverC=-1},{passive:!1}),e.addEventListener("mousedown",n=>{t._dragging=!0,t._lastX=n.clientX,t._lastY=n.clientY,t._startX=n.clientX,t._startY=n.clientY,t._didDrag=!1}),e.addEventListener("mousemove",n=>{const[s,r]=l(n.clientX,n.clientY);if(t.hoverR=s,t.hoverC=r,t._dragging){const f=n.clientX-t._lastX,h=n.clientY-t._lastY;t.camX+=f,t.camY+=h,t._lastX=n.clientX,t._lastY=n.clientY;const c=n.clientX-t._startX,y=n.clientY-t._startY;(Math.abs(c)>5||Math.abs(y)>5)&&(t._didDrag=!0)}}),e.addEventListener("mouseup",n=>{if(!t._didDrag){const[s,r]=l(n.clientX,n.clientY);s>=0&&r>=0&&o(s,r)}t._dragging=!1}),e.addEventListener("mouseleave",()=>{t._dragging=!1,t.hoverR=-1,t.hoverC=-1}),e.addEventListener("wheel",n=>{n.preventDefault();const s=n.deltaY>0?.9:1.1;t.zoom=Math.max(.4,Math.min(3,t.zoom*s))},{passive:!1})}const fe="minicity_save_v2",Z="minicity_tutorial_done";function K(e){const t={grid:e.grid,money:e.money,population:e.population,happiness:e.happiness,tick:e.tick,speed:e.speed,dayTime:e.dayTime,totalBuildings:e.totalBuildings,totalMoneyEarned:e.totalMoneyEarned,achievementsUnlocked:e.achievementsUnlocked};try{localStorage.setItem(fe,JSON.stringify(t))}catch{}}function Pt(){try{const e=localStorage.getItem(fe);if(!e)return null;const t=JSON.parse(e);return!t.grid||t.grid.length!==u?null:{grid:t.grid,money:t.money??1e3,population:t.population??0,happiness:t.happiness??50,tick:t.tick??0,citizens:[],smoke:[],speed:t.speed??1,events:[],dayTime:t.dayTime??.35,totalBuildings:t.totalBuildings??0,totalMoneyEarned:t.totalMoneyEarned??0,notifications:[],achievementsUnlocked:t.achievementsUnlocked??[]}}catch{return null}}let d=Pt()||Me(),E="residential",W=!1;const P=Tt(),A=Ne();for(const e of A)d.achievementsUnlocked.includes(e.id)&&(e.unlocked=!0);const _=document.getElementById("game"),Rt=_.getContext("2d");function Te(){const e=window.devicePixelRatio||1;_.width=window.innerWidth*e,_.height=window.innerHeight*e,_.style.width=window.innerWidth+"px",_.style.height=window.innerHeight+"px"}Te();window.addEventListener("resize",Te);const Ct=document.getElementById("hud-money"),ve=document.getElementById("hud-income"),It=document.getElementById("hud-pop"),ye=document.getElementById("hud-happy"),Lt=document.getElementById("hud-time"),z=document.getElementById("toast");let be=0;function R(e,t){z.textContent=e,z.style.background=t||"rgba(233,69,96,0.92)",z.classList.add("show"),clearTimeout(be),be=window.setTimeout(()=>z.classList.remove("show"),1800)}function N(){Ct.textContent="$"+d.money.toLocaleString();const e=re(d.grid);ve.textContent=(e>=0?"+":"")+e+"/s",ve.style.color=e>=0?"#4ade80":"#f87171",It.textContent=d.population.toLocaleString(),ye.textContent=d.happiness+"%",ye.style.color=d.happiness>=70?"#4ade80":d.happiness>=40?"#facc15":"#f87171",Lt.textContent=at(d.dayTime)}const Ee=document.querySelectorAll(".speed-btn");function de(){Ee.forEach(e=>{const t=parseInt(e.dataset.speed||"1");e.classList.toggle("active",t===d.speed)})}Ee.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const o=parseInt(e.dataset.speed||"1");d={...d,speed:o},de(),R("Speed: "+["Paused","Normal","Fast","Turbo"][o],"rgba(100,120,180,0.92)")})});const Pe={empty:"‚úï",residential:"‚åÇ",commercial:"$",industrial:"‚öô",park:"‚ô£",road:"‚ïê",power:"‚ö°",hospital:"+",school:"ùó•",fire_station:"üö®",police:"‚öë"};function $(){const e=document.getElementById("toolbar");e.innerHTML="";const t={};for(const i of Xe){const l=v[i].category;t[l]||(t[l]=[]),t[l].push(i)}for(const[i,l]of Object.entries(t)){const n=document.createElement("div");n.className="toolbar-cat",n.textContent=He[i]||i,e.appendChild(n);for(const s of l){const r=v[s],f=document.createElement("div");f.className="tool-btn"+(s===E&&!W?" active":""),r.cost>d.money&&s!=="empty"&&f.classList.add("disabled"),f.innerHTML=`
        <span class="tool-icon">${Pe[s]}</span>
        <span class="tool-name">${r.label}</span>
        ${r.cost>0?`<span class="tool-cost">$${r.cost}</span>`:""}
      `,f.addEventListener("click",h=>{h.stopPropagation(),E=s,W=!1,$()}),e.appendChild(f)}}const o=document.createElement("div");o.className="tool-btn"+(W?" active inspect-active":""),o.innerHTML=`
    <span class="tool-icon">üîç</span>
    <span class="tool-name">Inspect</span>
  `,o.addEventListener("click",i=>{i.stopPropagation(),W=!W,$()}),e.appendChild(o)}const Re=document.getElementById("info-panel"),_t=document.getElementById("info-close");function j(e,t){const o=d.grid[e][t];if(o.type==="empty"){pe();return}const i=v[o.type],l=Mt(d,e,t);if(!l)return;const n=o.level<3&&i.upgradeCostMult>0,s=ie(o.type,o.level),r=d.money>=s;let f=`
    <div class="info-header">
      <span class="info-icon">${Pe[o.type]}</span>
      <div>
        <div class="info-title">${i.label} <span class="info-level">Lv.${o.level}</span></div>
        <div class="info-desc">${i.description}</div>
      </div>
    </div>
    <div class="info-stats">
      ${l.income!==0?`<div class="info-stat"><span>Income</span><span style="color:${l.income>=0?"#4ade80":"#f87171"}">${l.income>=0?"+":""}$${l.income}/s</span></div>`:""}
      ${l.population!==0?`<div class="info-stat"><span>Population</span><span style="color:#60a0ff">+${l.population}</span></div>`:""}
      ${l.happiness!==0?`<div class="info-stat"><span>Happiness</span><span style="color:${l.happiness>=0?"#4ade80":"#f87171"}">${l.happiness>=0?"+":""}${l.happiness}</span></div>`:""}
      ${l.adjacencyIncome!==0?`<div class="info-stat adj"><span>Adj. Income</span><span style="color:#facc15">+$${l.adjacencyIncome}/s</span></div>`:""}
      ${l.adjacencyHappiness!==0?`<div class="info-stat adj"><span>Adj. Happy</span><span style="color:${l.adjacencyHappiness>=0?"#facc15":"#f87171"}">${l.adjacencyHappiness>=0?"+":""}${l.adjacencyHappiness}</span></div>`:""}
    </div>
    ${o.onFire?'<div class="info-fire">ON FIRE! Waiting for fire to end...</div>':""}
    ${n?`
      <button class="info-upgrade-btn ${r?"":"disabled"}" id="upgrade-btn">
        Upgrade to Lv.${o.level+1} - $${s.toLocaleString()}
      </button>
    `:o.level>=3?'<div class="info-maxlevel">MAX LEVEL</div>':""}
  `;document.getElementById("info-content").innerHTML=f,Re.classList.add("show");const h=document.getElementById("upgrade-btn");h&&h.addEventListener("click",c=>{c.stopPropagation();const y=wt(d,e,t);y?(d=y,R("Upgraded to Lv."+d.grid[e][t].level,"rgba(74,222,128,0.92)"),j(e,t),N(),$(),K(d)):R("Not enough $")})}function pe(){Re.classList.remove("show")}_t.addEventListener("click",e=>{e.stopPropagation(),pe()});const $t=document.getElementById("stats-btn"),he=document.getElementById("stats-panel"),Bt=document.getElementById("stats-close");function Wt(){const e=H(d.grid),t=re(d.grid),o=Object.entries(e).reduce((n,[s,r])=>s!=="empty"&&s!=="road"?n+r:n,0),i=e.power*20;let l=`
    <div class="stats-section">
      <div class="stats-title">Economy</div>
      <div class="stats-row"><span>Balance</span><span>$${d.money.toLocaleString()}</span></div>
      <div class="stats-row"><span>Income/tick</span><span style="color:${t>=0?"#4ade80":"#f87171"}">${t>=0?"+":""}$${t}</span></div>
      <div class="stats-row"><span>Total Earned</span><span>$${d.totalMoneyEarned.toLocaleString()}</span></div>
    </div>
    <div class="stats-section">
      <div class="stats-title">Population</div>
      <div class="stats-row"><span>Citizens</span><span>${d.population}</span></div>
      <div class="stats-row"><span>Happiness</span><span>${d.happiness}%</span></div>
    </div>
    <div class="stats-section">
      <div class="stats-title">Infrastructure</div>
      <div class="stats-row"><span>Power</span><span>${i} / ${o} needed</span></div>
      <div class="stats-row"><span>Buildings</span><span>${d.totalBuildings} / ${u*u}</span></div>
    </div>
    <div class="stats-section">
      <div class="stats-title">Buildings</div>
      ${Object.entries(e).filter(([n,s])=>n!=="empty"&&s>0).map(([n,s])=>`<div class="stats-row"><span>${v[n].label}</span><span>${s}</span></div>`).join("")}
    </div>
    <div class="stats-section">
      <div class="stats-title">Active Events</div>
      ${d.events.length===0?'<div class="stats-row dim">No active events</div>':d.events.map(n=>`<div class="stats-row event-row"><span>${n.label}</span><span>${n.duration} ticks left</span></div>`).join("")}
    </div>
  `;document.getElementById("stats-content").innerHTML=l}$t.addEventListener("click",e=>{e.stopPropagation(),Wt(),he.classList.toggle("show")});Bt.addEventListener("click",e=>{e.stopPropagation(),he.classList.remove("show")});const At=document.getElementById("achievements-btn"),ue=document.getElementById("achievements-panel"),Dt=document.getElementById("ach-close");function Yt(){let e="";for(const o of A)e+=`
      <div class="ach-item ${o.unlocked?"unlocked":"locked"}">
        <span class="ach-icon">${o.unlocked?o.icon:"?"}</span>
        <div class="ach-info">
          <div class="ach-name">${o.unlocked?o.label:"???"}</div>
          <div class="ach-desc">${o.description}</div>
        </div>
      </div>
    `;document.getElementById("ach-content").innerHTML=e;const t=A.filter(o=>o.unlocked).length;document.getElementById("ach-count").textContent=`${t}/${A.length}`}At.addEventListener("click",e=>{e.stopPropagation(),Yt(),ue.classList.toggle("show")});Dt.addEventListener("click",e=>{e.stopPropagation(),ue.classList.remove("show")});function Ce(){for(const e of A)!e.unlocked&&e.check(d)&&(e.unlocked=!0,d.achievementsUnlocked.includes(e.id)||(d={...d,achievementsUnlocked:[...d.achievementsUnlocked,e.id]}),Xt(e))}function Xt(e){const t=document.getElementById("achievement-toast");t.innerHTML=`<span class="ach-toast-icon">${e.icon}</span> ${e.label}`,t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),3e3)}const Se=document.getElementById("notifications");function Ie(){const e=d.notifications.slice(-5);Se.innerHTML="";for(const t of e){const o=Date.now()-t.time;if(o>1e4)continue;const i=Math.max(0,1-o/1e4),l=document.createElement("div");l.className="notif-item",l.style.opacity=String(i),l.style.borderLeftColor=t.color,l.textContent=t.text,Se.appendChild(l)}}function Le(){const e=document.getElementById("event-banner");if(d.events.length===0){e.classList.remove("show");return}const t=d.events[0];e.textContent=t.label+" ("+t.duration+" ticks)",e.className="event-banner show event-"+t.type}const Ht=document.getElementById("rotate-btn");Ht.addEventListener("click",e=>{e.stopPropagation(),P.rotation=(P.rotation+1)%4,R("View: "+["N","E","S","W"][P.rotation],"rgba(100,120,180,0.92)")});const G=document.getElementById("tutorial"),Nt=localStorage.getItem(Z);let X=0;const ee=[{text:"Welcome to MiniCity! Build and manage your own isometric city.",target:""},{text:"Select buildings from the toolbar below. Start with a House to get population.",target:"toolbar"},{text:"Tap on the grid to place buildings. Watch your money and income!",target:"game"},{text:"Use the stats panel to track your city, and upgrade buildings by inspecting them.",target:"stats-btn"},{text:"Build Fire Stations to prevent disasters, Schools for income bonuses, and Hospitals for population growth.",target:""},{text:"Place buildings strategically - adjacency bonuses reward good planning!",target:""}];function _e(){if(Nt){G.style.display="none";return}$e()}function $e(){if(X>=ee.length){G.style.display="none",localStorage.setItem(Z,"1");return}G.style.display="flex";const e=ee[X];document.getElementById("tutorial-text").textContent=e.text,document.getElementById("tutorial-progress").textContent=`${X+1}/${ee.length}`}document.getElementById("tutorial-next").addEventListener("click",e=>{e.stopPropagation(),X++,$e()});document.getElementById("tutorial-skip").addEventListener("click",e=>{e.stopPropagation(),G.style.display="none",localStorage.setItem(Z,"1")});Et(_,P,(e,t)=>{if(W){j(e,t);return}if(d.grid[e][t].type!=="empty"&&E!=="empty"&&d.grid[e][t].type===E){j(e,t);return}const o=kt(d,e,t,E);o?(d=o,E==="empty"?R("Demolished!"):R(v[E].label+" placed","rgba(74,222,128,0.85)"),N(),$(),K(d),Ce()):d.grid[e][t].type!=="empty"&&E!=="empty"?j(e,t):E!=="empty"&&d.money<v[E].cost&&R("Not enough $")});let te=null;function Ot(){switch(d.speed){case 0:return 0;case 1:return 2e3;case 2:return 1e3;case 3:return 500;default:return 2e3}}function Ft(){d=St(d),N(),$(),Le(),Ie(),Ce(),K(d)}function Be(){te&&clearInterval(te);const e=Ot();e>0&&(te=window.setInterval(Ft,e))}let ke=d.speed;function zt(){d.speed!==ke&&(ke=d.speed,Be())}Be();let oe=0;function We(e){const t=oe?e-oe:16;oe=e,zt(),d={...d,citizens:ut(d,d.speed===0?0:t),smoke:mt(d.smoke,d.speed===0?0:t)},rt(Rt,_,d,P.camX,P.camY,P.zoom,P.rotation,P.hoverR,P.hoverC),Ie(),requestAnimationFrame(We)}document.getElementById("new-game-btn").addEventListener("click",e=>{if(e.stopPropagation(),confirm("Start a new city? All progress will be lost.")){localStorage.removeItem(fe),localStorage.removeItem(Z),d=Me();for(const t of A)t.unlocked=!1;N(),$(),de(),pe(),he.classList.remove("show"),ue.classList.remove("show"),R("New city started!","rgba(100,120,180,0.92)"),K(d),X=0,_e()}});N();$();de();Le();_e();requestAnimationFrame(We);
